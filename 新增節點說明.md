# 新增節點說明

本次更新新增了 幾個實用節點，擴展了 ComfyUI TextBatch 的功能。
最近看到Qwen Image Edit 搭配Next Sence Lora可以預測下一場景。於是想到若能搭配節點讀取生成後的圖片，作為新來源，讓它自行反覆循環，於是添加以下這些節點。


## 1. ImageQueueProcessorPlus - 圖片佇列處理增強版

### 功能說明
這是 `ImageQueueProcessor` 的增強版本，新增了以下功能：
- **雙圖片輸入**：除了主要的 `images` 輸入，還有一個可選的 `additional_image` 輸入(用處不大，本來是想用它來實現循環)
- **變數來源**:可以搭配Data Temp Set 一起使用，將指定變數內的圖片作為來源圖。(可以把Data Temp Set 放在Vae Decode 之後)
- **動態佇列管理**：可以在處理過程中將新生成的圖片添加到佇列中
- **自動循環控制**：支持設定最大執行索引和循環開關

### 輸入參數
- `images` (IMAGE) - 初始圖片批次
- `additional_image` (IMAGE, 可選) - 額外的圖片輸入，會被添加到佇列末尾
- `start_index` (INT) - 開始處理的索引位置 (預設: 0)
- `max_index` (INT) - 最大執行索引，達到此索引時自動停止 (預設: 10)
- `trigger_next` (BOOLEAN) - 是否觸發下一個處理 (預設: True)
- `enable_loop` (BOOLEAN) - 循環開關，關閉時停止自動觸發 (預設: True)
- `data_tmp_var` (String) - 變數名稱。(對應Data Temp Set 變數名稱)
- `use_data_tmp` (BOOL) - 是否使用變數做為圖片來源。

### 輸出
- `image` (IMAGE) - 當前處理的圖片
- `current_index` (INT) - 當前索引
- `total` (INT) - 佇列中的總圖片數
- `completed` (BOOLEAN) - 是否完成處理
- `status` (STRING) - 狀態信息

### 使用場景
1. **迭代圖片處理**：首次加載一張圖，處理完畢後生成新圖，搭配Data Temp Set，繼續下一輪處理
2. **限制處理次數**：設定 `max_index` 來控制最多處理幾輪(避免無限循環)
3. **條件停止**：透過 `enable_loop` 開關來手動控制是否繼續處理

### 範例工作流程
```
LoadImage → ImageQueueProcessorPlus → 圖片處理節點 → Data Temp Set  → 輸出
                     ↑                            |
                     └─────Data Temp Set Name─────┘
```

---

## 2. TextSplitGet - 文本分割與獲取

### 功能說明
將文本自動分割成群組，並可指定索引來獲取特定的文本項目。

### 輸入參數
- `text` (STRING) - 要分割的文本
- `index` (INT) - 要獲取的項目索引 (預設: 0)
- `separator_type` (選項) - 分隔符類型
  - `newline` - 換行符 (預設)
  - `comma` - 逗號
  - `semicolon` - 分號
  - `custom` - 自訂分隔符
- `custom_separator` (STRING) - 自訂分隔符 (預設: "|")
- `ignore_comment` (BOOLEAN) - 是否忽略註解行 (預設: True)
- `comment_prefix` (STRING) - 註解前綴符號 (預設: "#")
- `trim_whitespace` (BOOLEAN) - 是否去除前後空白 (預設: True)

### 輸出
- `text` (STRING) - 指定索引的文本
- `current_index` (INT) - 當前索引
- `total` (INT) - 分割後的總項目數
- `status` (STRING) - 狀態信息

### 使用範例

**範例 1：換行分割**
```
輸入文本：
1girl, red hair
1boy, blue eyes
# 這是註解
1cat, fluffy

index: 1
separator_type: newline
ignore_comment: True

結果：1boy, blue eyes
```

**範例 2：逗號分割**
```
輸入文本：
apple,banana,cherry,# comment,durian

index: 2
separator_type: comma
ignore_comment: True

結果：cherry
```

---

## 3. IFMatchCond - 數學條件判斷

### 功能說明
根據數學條件比較兩個數值，返回 True 或 False。支援整數和浮點數比較。

### 輸入參數
- `value_a` (FLOAT) - 第一個浮點數值 (預設: 0.0)
- `operator` (選項) - 比較運算符
  - `==` - 等於
  - `!=` - 不等於
  - `>` - 大於
  - `>=` - 大於等於
  - `<` - 小於
  - `<=` - 小於等於
- `value_b` (FLOAT) - 第二個浮點數值 (預設: 0.0)
- `int_a` (INT, 可選) - 第一個整數值 (預設: 0)
- `int_b` (INT, 可選) - 第二個整數值 (預設: 0)
- `use_int` (BOOLEAN, 可選) - 是否使用整數比較 (預設: False)

### 輸出
- `result` (BOOLEAN) - 比較結果
- `status` (STRING) - 比較的詳細信息

### 使用範例
```
value_a: 5.5
operator: >
value_b: 3.2
use_int: False

結果：
- result: True
- status: "5.5 > 3.2 = True"
```

### 應用場景
- 配合 `ImageQueueProcessorPlus` 的 `current_index` 來判斷是否達到特定輪數
- 與其他條件節點配合使用，實現複雜的工作流程控制

---

## 4. DataTmpSet - 資料暫存器設置

### 功能說明
將資料存儲到記憶體中的全局暫存器，支援文本、圖片和任意類型的資料。可以存儲為單一變數或陣列。

### 輸入參數
- `var_name` (STRING) - 變數名稱 (預設: "my_var")
- `storage_mode` (選項) - 存儲模式
  - `variable` - 單一變數 (預設)
  - `array` - 陣列模式
- `data_type` (選項) - 資料類型
  - `text` - 文本 (預設)
  - `image` - 圖片
  - `any` - 任意類型
- `text_data` (STRING, 可選) - 文本資料
- `image_data` (IMAGE, 可選) - 圖片資料
- `any_data` (ANY, 可選) - 任意類型資料
- `array_index` (INT, 可選) - 陣列索引，-1 表示添加到末尾 (預設: -1)

### 輸出
- `status` (STRING) - 操作狀態信息

### 使用範例

**範例 1：存儲文本變數**
```
var_name: "my_prompt"
storage_mode: variable
data_type: text
text_data: "1girl, beautiful"

結果：將文本存儲到變數 "my_prompt"
```

**範例 2：建立圖片陣列**
```
第一次執行：
var_name: "image_history"
storage_mode: array
data_type: image
image_data: [圖片1]
array_index: -1

第二次執行：
var_name: "image_history"
storage_mode: array
data_type: image
image_data: [圖片2]
array_index: -1

結果：陣列 "image_history" 包含兩張圖片
```

---

## 5. DataTmpGet - 資料暫存器讀取

### 功能說明
從全局暫存器中讀取之前存儲的資料。

### 輸入參數
- `var_name` (STRING) - 要讀取的變數名稱 (預設: "my_var")
- `data_type` (選項) - 資料類型
  - `text` - 文本 (預設)
  - `image` - 圖片
  - `any` - 任意類型
- `array_index` (INT, 可選) - 陣列索引，-1 表示讀取整個變數 (預設: -1)
- `default_text` (STRING, 可選) - 找不到資料時的預設文本

### 輸出
- `text` (STRING) - 文本資料
- `image` (IMAGE) - 圖片資料
- `any` (ANY) - 任意類型資料
- `status` (STRING) - 操作狀態信息

### 使用範例

**範例 1：讀取文本變數**
```
var_name: "my_prompt"
data_type: text

結果：返回之前存儲的文本
```

**範例 2：讀取陣列中的特定圖片**
```
var_name: "image_history"
data_type: image
array_index: 1

結果：返回陣列中索引為 1 的圖片
```

---

## 綜合應用範例

### 場景：迭代圖片增強工作流程

1. **初始設定**
   - 使用 `LoadImage` 加載初始圖片
   - 設定迭代次數為 5 次

2. **圖片處理循環**
   ```
   LoadImage → ImageQueueProcessorPlus (max_index=5, enable_loop=True)
                     ↓
               [當前圖片]
                     ↓
               圖片增強節點 (例如：放大、去噪)
                     ↓
               DataTmpSet (儲存處理結果)
                     ↓
               連接回 additional_image
   ```

3. **條件控制**
   - 使用 `IFMatchCond` 檢查 `current_index` 是否達到目標
   - 根據條件決定是否繼續處理

4. **結果保存**
   - 使用 `DataTmpGet` 讀取所有處理過的圖片
   - 使用 `SaveImage` 保存最終結果

---

## 注意事項

1. **ImageQueueProcessorPlus**
   - `additional_image` 會被添加到佇列末尾，不會替換現有圖片
   - 當達到 `max_index` 或 `enable_loop` 為 False 時，循環會停止
   - 狀態文件保存在 `image_queue_processor_plus_state.json`

2. **TextSplitGet**
   - 註解過濾在分割後執行，以 `comment_prefix` 開頭的行會被忽略
   - 空行會被自動過濾掉

3. **資料暫存器 (DataTmpSet/DataTmpGet)**
   - 資料存儲在記憶體中，ComfyUI 重啟後會清空
   - 全局共享，不同工作流程可以存取相同的變數
   - 陣列索引超出範圍時會自動擴展陣列（填充 None）

4. **IFMatchCond**
   - 浮點數比較時要注意精度問題
   - 使用 `use_int=True` 可以進行整數比較，避免浮點數精度誤差

---

## 安裝說明

這些節點已經整合到現有的 `modules/textbatch/nodes.py` 檔案中。

重新啟動 ComfyUI 後，在節點選單的 **TextBatch** 分類中可以找到以下新節點：
- Image Queue Processor Plus
- Text Split Get
- IF Match Condition
- Data Temp Set
- Data Temp Get

## 技術支援

如有問題或建議，請在專案的 GitHub 頁面提出 Issue。

